<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{template/layout/base_head_component :: common-header}"></th:block>
    <th:block th:replace="~{template/layout/base_head_component :: field-error-style}"></th:block>
    <th:block th:replace="~{template/layout/base_head_component :: font-awesome-load}"></th:block>
    <title>학급 정보 페이지 입니다.</title>
</head>
<body>


<div class="container mt-3" th:object="${classRoomDetailInfoDto}">

    <button type="button" class="btn btn-primary btn-sm">학생 추가</button>
    <button type="button" class="btn btn-primary btn-sm">전체 선택/해제</button>
    <button type="button" class="btn btn-primary btn-sm">선택한 학생 삭제</button>

    <div class=" mt-1 border border-primary-subtle border-3 rounded p-3">
        <!-- 알림장 작성 폼 시작 -->
        <h3>알림장 작성</h3>
        <textarea class="form-control" rows="5" placeholder="알림장 내용을 여기에 작성하세요."></textarea>
        <button type="button" class="btn btn-primary mt-2">알림장 보내기</button>
        <!-- 알림장 작성 폼 끝 -->
    </div>


    <!-- 숙제 및 알림장 목록 -->
    <table class="table mt-3">
        <thead>
        <tr>
            <th scope="col">#</th>
            <th scope="col">내용</th>
            <th scope="col">날짜</th>
        </tr>
        </thead>
        <tbody>
        <!-- 여기에 숙제 및 알림장 정보를 동적으로 추가 -->
        </tbody>
    </table>
</div>

<script>
    $("#searchForm").submit(function (event) {
        event.preventDefault(); // 폼 제출 기본 동작을 중지합니다.

        var formData = $(this).serialize(); // 폼 데이터를 가져옵니다.
        var url = $(this).attr('action'); // 폼의 액션 URL을 가져옵니다.

        $.ajax({
            url: url,
            type: 'GET',
            data: formData,
            dataType: 'json',
            success: function (response) {

                $(".main-content").empty(); // ".main-content" 내용을 비우기. 새로운 내용으로 채우기 위함

                if (response.errorResult !== null) {
                    var errorMessage = response.errorResult.message;
                    displayErrorMessage(errorMessage);
                } else {
                    var resultHtml =
                        '<table class="table table-hover">' +
                        '<thead>' +
                        '    <tr>' +
                        '        <th scope="col">학교명</th>' +
                        '        <th scope="col">학년</th>' +
                        '        <th scope="col">이름</th>' +
                        '        <th scope="col"></th>' +
                        '    </tr>' +
                        '</thead>' +
                        '<tbody>';

                    // 각 학생 정보에 대한 행을 추가
                    $.each(response.data, function (index, student) {
                        resultHtml +=
                            '<tr>' +
                            '    <td>' +
                            '        <a href="/record/' + student.id + '">' + student.schoolName + '</a>' +
                            '    </td>' +
                            '    <td>' +
                            '        <a href="/record/' + student.id + '">' + student.grade + '</a>' +
                            '    </td>' +
                            '    <td>' +
                            '        <a href="/record/' + student.id + '">' + student.name + '</a>' +
                            '    </td>' +
                            '    <td>' +
                            '        <button class="btn btn-primary add-student-button add-student-button" data-id="' + student.id + '">추가</button>' + // '추가' 버튼 추가
                            '    </td>' +
                            '</tr>';
                    });

                    resultHtml += '</tbody></table>';

                    // 결과 HTML을 ".main-content"에 추가
                    $(".main-content").empty().append(resultHtml);

                }

            },
            error: function (xhr, status, error) {
                var errorMessage = "검색어를 입력하지 않습니다.";
                displayErrorMessage(errorMessage);
            }
        });
    });

    function displayErrorMessage(message) {
        var errorHtml = '<div class="alert alert-danger text-center">' + message + '</div>';
        $(".main-content").html(errorHtml);
    }

    // 선택된 학생 목록을 저장하기 위한 배열
    var selectedStudents = [];

    // '추가' 버튼 클릭 이벤트 처리
    $(document).on('click', '.add-student-button', function () {
        var studentId = $(this).data('id');
        var studentSchoolName = $(this).closest('tr').find('td:eq(0) a').text();
        var studentGrade = $(this).closest('tr').find('td:eq(1) a').text();
        var studentName = $(this).closest('tr').find('td:eq(2) a').text();

        // 동일한 학생이 이미 목록에 있는지 확인
        var isStudentAlreadySelected = selectedStudents.some(function (student) {
            return student.id === studentId;
        });

        if (!isStudentAlreadySelected) {
            // 선택된 학생 정보 객체 생성
            var studentInfo = {
                id: studentId,
                schoolName: studentSchoolName,
                grade: studentGrade,
                name: studentName
            };

            // 학생 목록에 추가
            selectedStudents.push(studentInfo);

            // 선택된 학생 목록 업데이트
            updateSelectedStudentsList();
        } else {
            // 선택된 학생이 이미 목록에 있을 경우, 사용자에게 알림
            alert('이미 추가된 학생입니다.');
        }
    });

    // 선택된 학생 목록을 업데이트하는 함수
    function updateSelectedStudentsList() {
        var listHtml = '';
        $.each(selectedStudents, function (index, student) {
            listHtml += '<li>' + student.schoolName + ' ' + student.grade + '학년 ' + student.name +
                ' <button class="btn btn-danger remove-student-button btn-sm ml-1" data-id="' + student.id + '">취소</button></li>'; // '취소' 버튼 추가
        });
        $('#selected-students-list').html(listHtml);
    }

    // '취소' 버튼 클릭 이벤트 처리
    $(document).on('click', '.remove-student-button', function () {
        var studentId = $(this).data('id');

        // 선택된 학생 목록에서 해당 학생을 찾아 삭제
        selectedStudents = selectedStudents.filter(function (student) {
            return student.id !== studentId;
        });

        // 선택된 학생 목록 업데이트
        updateSelectedStudentsList();
    });

    // "학생 선택 완료" 버튼 클릭 이벤트 처리
    $('#add-students-button').click(function () {
        // 선택된 학생 목록을 하나의 문자열로 변환
        var selectedStudentsStr = selectedStudents.map(function (student) {
            return student.id + ' ';
        }).join('');

        // 숨겨진 입력 필드에 선택된 학생 목록 문자열을 설정
        $('#selectedStudentsInput').val(selectedStudentsStr);

        // 선택된 학생 목록을 보여주는 모달을 닫습니다.
        $('#staticBackdrop').modal('hide');
    });

</script>

</body>
</html>